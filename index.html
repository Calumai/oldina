<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2/21 æ¯èªæ—¥ - é›²ç«¯é€£ç·šç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0fdf4; touch-action: manipulation; }
        .btn-push { transition: all 0.1s; box-shadow: 0 6px 0 #b91c1c; }
        .btn-push:active { transform: translateY(6px); box-shadow: 0 0 0 #b91c1c; }
        .flag-btn { height: 160px; border-radius: 20px; font-size: 2rem; font-weight: bold; transition: transform 0.1s; }
        .flag-btn:active { transform: scale(0.95); }
        [v-cloak] { display: none; }
    </style>
</head>
<body class="h-screen overflow-hidden text-slate-800">

<div id="app" v-cloak class="h-full flex flex-col">

    <div v-if="view === 'home'" class="flex-1 flex flex-col items-center justify-center space-y-8 bg-gradient-to-br from-green-400 to-blue-500 text-white p-4 text-center">
        <h1 class="text-4xl md:text-5xl font-black mb-2 animate__animated animate__bounceIn">æ¯èªæ—¥äº’å‹•ä¸»æ§å°</h1>
        <p class="text-lg opacity-90">é›²ç«¯é€£ç·šç‰ˆ (PeerJS)</p>
        
        <div class="flex flex-col md:flex-row gap-6 mt-8 w-full max-w-2xl px-4">
            <button @click="initAdmin" class="flex-1 bg-white text-blue-600 py-8 rounded-2xl shadow-xl text-2xl font-bold hover:scale-105 transition transform flex flex-col items-center justify-center">
                <span>ğŸ‘¨â€ğŸ« æˆ‘æ˜¯é—œä¸» (è€å¸«)</span>
                <span class="text-sm font-normal text-gray-500 mt-2">å»ºç«‹æˆ¿é–“ï¼Œé¡¯ç¤ºåœ¨å¤§è¢å¹•</span>
            </button>
            <button @click="view = 'scan'" class="flex-1 bg-white text-green-600 py-8 rounded-2xl shadow-xl text-2xl font-bold hover:scale-105 transition transform flex flex-col items-center justify-center">
                <span>ğŸ™‹â€â™‚ï¸ æˆ‘æ˜¯å­¸ç”Ÿ (æ‰‹æ©Ÿ)</span>
                <span class="text-sm font-normal text-gray-500 mt-2">æƒç¢¼æˆ–è¼¸å…¥IDé€£ç·š</span>
            </button>
        </div>
    </div>

    <div v-if="view === 'scan'" class="flex-1 flex flex-col items-center justify-center bg-slate-100 p-6">
        <div class="bg-white p-8 rounded-3xl shadow-xl w-full max-w-md text-center">
            <h2 class="text-2xl font-bold mb-6 text-slate-700">è¼¸å…¥è€å¸«çš„æˆ¿é–“ ID</h2>
            <input v-model="targetId" type="text" placeholder="ä¾‹å¦‚: happy-123" class="w-full text-center text-3xl font-mono border-2 border-gray-300 rounded-xl py-4 mb-6 uppercase focus:border-green-500 outline-none">
            <button @click="connectToAdmin" :disabled="!targetId" class="w-full bg-green-600 text-white py-4 rounded-xl text-xl font-bold hover:bg-green-700 disabled:opacity-50">
                ğŸš€ é€£ç·šï¼
            </button>
            <button @click="view = 'home'" class="mt-4 text-gray-500 underline">è¿”å›é¦–é </button>
        </div>
    </div>

    <div v-if="view === 'admin'" class="h-full flex flex-col md:flex-row">
        <div class="w-full md:w-1/4 bg-slate-800 text-white p-4 flex flex-col space-y-4">
            <div class="bg-slate-700 p-3 rounded-lg text-center">
                <p class="text-xs text-gray-400 mb-1">æˆ¿é–“ ID (è«‹å­¸ç”Ÿè¼¸å…¥):</p>
                <div class="text-2xl font-mono font-bold text-yellow-400 tracking-wider">{{ myId }}</div>
            </div>
            
            <div class="flex-1 space-y-3 overflow-y-auto">
                <p class="text-gray-400 text-xs font-bold uppercase">åˆ‡æ›æ¨¡å¼</p>
                <button @click="setMode('left_right')" :class="mode === 'left_right' ? 'bg-blue-600' : 'bg-slate-700'" class="w-full text-left px-4 py-3 rounded-lg transition">ğŸš© å·¦å³è­·æ³•</button>
                <button @click="setMode('ordering')" :class="mode === 'ordering' ? 'bg-green-600' : 'bg-slate-700'" class="w-full text-left px-4 py-3 rounded-lg transition">ğŸ” é»é¤å¤§è€ƒé©—</button>
                <button @click="setMode('lottery')" :class="mode === 'lottery' ? 'bg-purple-600' : 'bg-slate-700'" class="w-full text-left px-4 py-3 rounded-lg transition">ğŸ å¹¸é‹æŠ½ç</button>
            </div>

            <div class="pt-2 border-t border-slate-600">
                <div class="flex items-center text-sm">
                    <span class="w-2 h-2 rounded-full mr-2" :class="connectionCount > 0 ? 'bg-green-500 animate-pulse' : 'bg-red-500'"></span>
                    <span>å·²é€£ç·šè£ç½®: {{ connectionCount }}</span>
                </div>
            </div>
        </div>

        <div class="flex-1 bg-gray-100 flex flex-col items-center justify-center p-4 relative overflow-hidden">
            
            <div v-if="connectionCount === 0" class="absolute inset-0 bg-black/80 z-50 flex flex-col items-center justify-center text-white p-8 text-center backdrop-blur-sm">
                <h3 class="text-3xl font-bold mb-4">ç­‰å¾…å­¸ç”Ÿé€£ç·š...</h3>
                <div class="bg-white p-4 rounded-xl mb-4">
                    <img :src="`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(shareUrl)}`" alt="QR Code" class="w-48 h-48">
                </div>
                <p class="text-xl">è«‹æƒæ æˆ– è¼¸å…¥ ID: <span class="text-yellow-400 font-mono font-bold">{{ myId }}</span></p>
                <button @click="connectionCount = 1" class="mt-8 text-sm text-gray-400 underline">è·³éç­‰å¾… (æ¸¬è©¦ç”¨)</button>
            </div>

            <div v-if="mode === 'left_right'" class="text-center w-full max-w-4xl">
                <h3 class="text-2xl md:text-4xl font-bold mb-8 text-slate-700">å·¦å³è­·æ³•ï¼šè½éŸ³è¾¨ä½</h3>
                <div class="flex justify-center gap-6 mb-12">
                    <div class="w-32 h-32 md:w-48 md:h-48 bg-red-500 text-white rounded-3xl flex items-center justify-center text-4xl shadow-lg">å·¦</div>
                    <div class="w-32 h-32 md:w-48 md:h-48 bg-white border-4 border-slate-200 text-slate-800 rounded-3xl flex items-center justify-center text-4xl shadow-lg">å³</div>
                </div>
                <div v-if="lastAction" class="bg-white p-6 rounded-2xl shadow-xl inline-block animate__animated animate__tada">
                    <span class="text-6xl block mb-2">{{ lastAction === 'left' ? 'ğŸ”´' : 'âšª' }}</span>
                    <span class="text-xl font-bold text-slate-600">å­¸ç”Ÿèˆ‰äº†{{ lastAction === 'left' ? 'ç´…æ——' : 'ç™½æ——' }}!</span>
                </div>
                <div v-else class="text-gray-400 text-xl animate-pulse">ç­‰å¾…å­¸ç”Ÿèˆ‰æ——...</div>
            </div>

            <div v-if="mode === 'ordering'" class="text-center w-full h-full flex flex-col items-center justify-center">
                <div v-if="currentMenu" class="bg-white p-8 rounded-3xl shadow-2xl animate__animated animate__zoomIn max-w-md w-full">
                    <div class="text-9xl mb-6">{{ currentMenu.emoji }}</div>
                    <div class="text-4xl font-black text-slate-800 mb-2">{{ currentMenu.name }}</div>
                    <div class="text-3xl text-blue-600 font-mono bg-blue-50 py-2 rounded-lg">{{ currentMenu.pronunciation }}</div>
                </div>
                <div v-else class="text-gray-400 text-2xl">ğŸ‘‡ è«‹åœ¨æ‰‹æ©Ÿé»é¸é¤é»</div>
            </div>

            <div v-if="mode === 'lottery'" class="text-center">
                <h3 class="text-4xl font-black text-purple-600 mb-8">å¹¸é‹å¤§æŠ½ç</h3>
                <div class="bg-white w-80 h-64 md:w-96 flex items-center justify-center rounded-3xl shadow-2xl border-8 border-purple-200 mb-8">
                    <div class="text-5xl font-bold text-slate-800">{{ lotteryResult }}</div>
                </div>
                <button @click="runLottery" :disabled="isRolling" class="bg-purple-600 text-white px-10 py-4 rounded-full text-2xl font-bold shadow-lg hover:bg-purple-700 disabled:opacity-50">
                    {{ isRolling ? 'è½‰å‹•ä¸­...' : 'é–‹å§‹æŠ½ç' }}
                </button>
            </div>
        </div>
    </div>

    <div v-if="view === 'client'" class="h-full bg-slate-100 p-4 flex flex-col">
        <div class="bg-white p-3 rounded-xl shadow-sm mb-4 flex justify-between items-center">
            <span class="font-bold text-blue-600 text-lg">{{ modeTitles[mode] }}</span>
            <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">ğŸŸ¢ å·²é€£ç·š</span>
        </div>

        <div v-if="mode === 'left_right'" class="flex-1 flex flex-col gap-4 justify-center pb-8">
            <button @click="sendAction('left')" class="flag-btn bg-red-500 text-white shadow-lg flex flex-col items-center justify-center btn-push">
                <span class="text-5xl mb-2">ğŸ”´</span>
                <span>å·¦é‚Š / æ˜¯</span>
            </button>
            <button @click="sendAction('right')" class="flag-btn bg-white text-slate-800 border-4 border-slate-200 shadow-lg flex flex-col items-center justify-center btn-push">
                <span class="text-5xl mb-2">âšª</span>
                <span>å³é‚Š / å¦</span>
            </button>
        </div>

        <div v-if="mode === 'ordering'" class="flex-1 overflow-y-auto pb-4">
            <p class="text-center text-gray-500 mb-4">è«‹é»é¸ä½ æƒ³åƒçš„æ±è¥¿ï¼š</p>
            <div class="grid grid-cols-2 gap-4">
                <button v-for="item in menuItems" :key="item.id" @click="sendMenu(item)" class="bg-white p-4 rounded-xl shadow border-2 border-transparent hover:border-blue-500 active:scale-95 transition flex flex-col items-center h-40 justify-center">
                    <span class="text-5xl mb-2">{{ item.emoji }}</span>
                    <span class="font-bold text-lg">{{ item.name }}</span>
                </button>
            </div>
        </div>

        <div v-if="mode === 'lottery'" class="flex-1 flex items-center justify-center flex-col">
            <div class="text-8xl mb-4 animate__animated animate__tada">ğŸ</div>
            <p class="text-xl font-bold text-slate-700">è«‹çœ‹å¤§è¢å¹•ï¼</p>
            <p class="text-gray-500 mt-2">ç¥ä½ å¥½é‹</p>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed } = Vue;

    createApp({
        setup() {
            const view = ref('home');
            const mode = ref('left_right');
            const myId = ref(''); // Admin ID
            const targetId = ref(''); // Student input ID
            const connectionCount = ref(0);
            
            // äº’å‹•è³‡æ–™
            const lastAction = ref(null);
            const currentMenu = ref(null);
            const menuItems = [
                { id: 1, name: 'ç³–æœ', emoji: 'ğŸ¬', pronunciation: 'Alufu' },
                { id: 2, name: 'é£›é¼ ', emoji: 'ğŸ¿ï¸', pronunciation: 'Paga' },
                { id: 3, name: 'å±±è±¬', emoji: 'ğŸ—', pronunciation: 'Babo' },
                { id: 4, name: 'è¬è¬', emoji: 'ğŸ™', pronunciation: 'Aray' }
            ];
            
            // æŠ½ç
            const isRolling = ref(false);
            const lotteryResult = ref('æº–å‚™é–‹å§‹');
            const prizes = ['é ­ç', 'äºŒç', 'å†ç©ä¸€æ¬¡', 'åƒåŠ ç', 'æ­å–œéé—œ'];

            // PeerJS ç‰©ä»¶
            let peer = null;
            let conn = null; // Adminä¿å­˜å¤šå€‹é€£ç·šå¤ªè¤‡é›œï¼Œé€™è£¡ç°¡åŒ–ç‚ºå»£æ’­
            let connections = []; // Adminç«¯å„²å­˜æ‰€æœ‰å­¸ç”Ÿé€£ç·š

            const modeTitles = {
                'left_right': 'ğŸš© å·¦å³è­·æ³•',
                'ordering': 'ğŸ” é»é¤å¤§è€ƒé©—',
                'lottery': 'ğŸ å¹¸é‹æŠ½ç'
            };
            
            // ç¶²å€åˆ†äº« (è®“QR Codeæ›´æ–¹ä¾¿)
            const shareUrl = computed(() => {
                const url = window.location.href.split('?')[0];
                return `${url}?id=${myId.value}`; // æ‚¨å¯ä»¥ç¨å¾Œå†å„ªåŒ–é€™è£¡çš„è‡ªå‹•å¸¶å…¥
            });

            // --- Admin: åˆå§‹åŒ– ---
            const initAdmin = () => {
                // ç”¢ç”Ÿä¸€å€‹éš¨æ©Ÿ ID (4ä½æ•¸ï¼Œæ–¹ä¾¿è¼¸å…¥)
                const randomId = Math.floor(1000 + Math.random() * 9000);
                myId.value = 'teacher-' + randomId;
                
                peer = new Peer(myId.value);
                
                peer.on('open', (id) => {
                    view.value = 'admin';
                });

                peer.on('connection', (c) => {
                    connections.push(c);
                    connectionCount.value++;
                    
                    // 1. å­¸ç”Ÿä¸€é€£ä¸Šä¾†ï¼Œé¦¬ä¸Šå‘Šè¨´ä»–ç¾åœ¨æ˜¯ä»€éº¼æ¨¡å¼
                    setTimeout(() => {
                        c.send({ type: 'MODE', payload: mode.value });
                    }, 500);

                    // 2. ç›£è½å­¸ç”Ÿå‚³ä¾†çš„è³‡æ–™
                    c.on('data', (data) => {
                        handleData(data);
                    });
                    
                    c.on('close', () => {
                        connectionCount.value--;
                    });
                });
            };

            // --- Client: é€£ç·š ---
            const connectToAdmin = () => {
                if(!targetId.value) return;
                // ä¿®æ­£ä½¿ç”¨è€…å¯èƒ½åªè¼¸å…¥æ•¸å­—çš„æƒ…æ³
                let fullId = targetId.value;
                if(!fullId.includes('teacher-')) fullId = 'teacher-' + fullId;

                peer = new Peer(); // Client ID è‡ªå‹•ç”Ÿæˆå³å¯
                
                peer.on('open', () => {
                    conn = peer.connect(fullId);
                    
                    conn.on('open', () => {
                        view.value = 'client';
                        // é€£ç·šæˆåŠŸæç¤º
                    });

                    conn.on('data', (data) => {
                        if(data.type === 'MODE') {
                            mode.value = data.payload;
                            // åˆ‡æ›æ¨¡å¼æ™‚é‡ç½®é¡¯ç¤º
                            currentMenu.value = null;
                        }
                    });
                    
                    conn.on('error', (err) => alert('é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ID'));
                });
            };

            // --- å…±ç”¨: è³‡æ–™è™•ç† ---
            const handleData = (data) => {
                if(data.type === 'ACTION') {
                    lastAction.value = data.payload;
                    // 3ç§’å¾Œæ¶ˆå¤±
                    setTimeout(() => { 
                        if(lastAction.value === data.payload) lastAction.value = null; 
                    }, 3000);
                }
                if(data.type === 'MENU') {
                    currentMenu.value = data.payload;
                }
            };

            // --- Admin æ“ä½œ ---
            const setMode = (m) => {
                mode.value = m;
                // å»£æ’­çµ¦æ‰€æœ‰é€£ç·šçš„å­¸ç”Ÿ
                connections.forEach(c => c.send({ type: 'MODE', payload: m }));
                // é‡ç½®
                lastAction.value = null;
                currentMenu.value = null;
            };

            const runLottery = () => {
                isRolling.value = true;
                let count = 0;
                const timer = setInterval(() => {
                    lotteryResult.value = prizes[Math.floor(Math.random() * prizes.length)];
                    count++;
                    if(count > 20) {
                        clearInterval(timer);
                        isRolling.value = false;
                        lotteryResult.value = prizes[Math.floor(Math.random() * prizes.length)];
                    }
                }, 100);
            };

            // --- Client æ“ä½œ ---
            const sendAction = (dir) => {
                if(conn) conn.send({ type: 'ACTION', payload: dir });
            };
            const sendMenu = (item) => {
                if(conn) conn.send({ type: 'MENU', payload: item });
            };

            return {
                view, mode, myId, targetId, connectionCount, shareUrl,
                initAdmin, connectToAdmin,
                modeTitles, lastAction, currentMenu, menuItems,
                setMode, runLottery, isRolling, lotteryResult,
                sendAction, sendMenu
            };
        }
    }).mount('#app');
</script>
</body>
</html>
