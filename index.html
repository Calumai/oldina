<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æœ¬åœŸèª AI è³¦èƒ½å·¥ä½œåŠ - æç¤ºè©å¤§æŒ‘æˆ°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <!-- å¼•å…¥ PeerJS ç”¨æ–¼è·¨è£ç½®é€£ç·š -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #0f172a; color: #e2e8f0; touch-action: manipulation; }
        .glass-panel { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .neon-text { text-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }
        /* éš±è—æœªç·¨è­¯çš„ Vue æ¨¡æ¿ */
        [v-cloak] { display: none; }
        
        /* è‡ªå®šç¾©æ²è»¸ - ç¸®å°å¯¬åº¦ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body class="h-screen overflow-hidden text-sm md:text-base">

<div id="app" v-cloak class="h-full flex flex-col">

    <!-- 1. é¦–é ï¼šèº«åˆ†é¸æ“‡ -->
    <div v-if="view === 'home'" class="flex-1 flex flex-col items-center justify-center space-y-6 bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 p-4 text-center relative overflow-hidden">
        <!-- èƒŒæ™¯è£é£¾ -->
        <div class="absolute top-0 left-0 w-full h-full opacity-20 pointer-events-none">
            <div class="absolute top-10 left-10 w-32 h-32 bg-blue-500 rounded-full blur-3xl"></div>
            <div class="absolute bottom-10 right-10 w-64 h-64 bg-purple-500 rounded-full blur-3xl"></div>
        </div>

        <h1 class="text-3xl md:text-5xl font-black mb-2 animate__animated animate__fadeInDown neon-text text-white">
            æœ¬åœŸèª AI è³¦èƒ½å·¥ä½œåŠ
        </h1>
        <p class="text-lg text-blue-300 font-mono tracking-widest">PROMPT ENGINEERING CHALLENGE</p>
        
        <div class="flex flex-col md:flex-row gap-4 mt-8 w-full max-w-xl px-4 z-10">
            <button @click="initAdmin" class="flex-1 glass-panel text-blue-300 py-6 rounded-2xl hover:bg-white/10 transition transform hover:scale-105 flex flex-col items-center border border-blue-500/30 cursor-pointer">
                <span class="text-4xl mb-2">ğŸ‘¨â€ğŸ’»</span>
                <span class="text-xl font-bold mb-1">è¬›å¸«ç«¯ (Host)</span>
                <span class="text-xs opacity-60">å»ºç«‹äº’å‹•æˆ¿é–“</span>
            </button>
            <button @click="view = 'scan'" class="flex-1 glass-panel text-purple-300 py-6 rounded-2xl hover:bg-white/10 transition transform hover:scale-105 flex flex-col items-center border border-purple-500/30 cursor-pointer">
                <span class="text-4xl mb-2">ğŸ“±</span>
                <span class="text-xl font-bold mb-1">å­¸å“¡ç«¯ (Join)</span>
                <span class="text-xs opacity-60">è¼¸å…¥ ID é€£ç·š</span>
            </button>
        </div>
    </div>

    <!-- 2. å­¸å“¡é€£ç·šé é¢ -->
    <div v-if="view === 'scan'" class="flex-1 flex flex-col items-center justify-center bg-slate-900 p-6">
        <div class="glass-panel p-6 rounded-2xl w-full max-w-sm text-center border-t border-purple-500/50">
            <h2 class="text-xl font-bold mb-4 text-white">è¼¸å…¥è¬›å¸«æä¾›çš„ ID</h2>
            <input v-model="targetId" type="tel" maxlength="4" placeholder="ä¾‹å¦‚: 1234" class="w-full text-center text-4xl font-mono bg-slate-800 border-2 border-slate-600 rounded-xl py-4 mb-6 text-white focus:border-purple-500 outline-none uppercase tracking-widest transition-colors">
            <button @click="connectToAdmin" :disabled="!targetId" class="w-full bg-purple-600 text-white py-3 rounded-xl text-lg font-bold hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed transition shadow-lg shadow-purple-900/50">
                ğŸš€ é€²å…¥æŒ‘æˆ°
            </button>
            <button @click="view = 'home'" class="mt-4 text-gray-500 hover:text-white transition underline text-sm">è¿”å›é¦–é </button>
        </div>
    </div>

    <!-- 3. è¬›å¸«æ§åˆ¶å° (Admin) -->
    <div v-if="view === 'admin'" class="h-full flex flex-col md:flex-row bg-slate-900">
        <!-- å·¦å´æ§åˆ¶é¢æ¿ (ç¸®å°å¯¬åº¦) -->
        <div class="w-full md:w-64 bg-slate-800/80 border-r border-slate-700 p-3 flex flex-col space-y-3 shadow-xl z-20">
            <div class="bg-blue-900/30 border border-blue-500/30 p-2 rounded-xl text-center">
                <p class="text-[10px] text-blue-300 mb-1 tracking-wider uppercase">Room ID</p>
                <div class="text-3xl md:text-4xl font-mono font-bold text-white tracking-widest">{{ displayId }}</div>
            </div>
            
            <div class="flex-1 space-y-2 overflow-y-auto mt-2 pr-1">
                <p class="text-gray-400 text-[10px] font-bold uppercase tracking-wider pl-2">æŒ‘æˆ°æ¨¡å¼</p>
                
                <button @click="setMode('quiz')" :class="mode === 'quiz' ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/50 ring-1 ring-blue-400' : 'bg-slate-700 text-gray-300 hover:bg-slate-600'" class="w-full text-left px-3 py-3 rounded-lg transition flex items-center">
                    <span class="text-xl mr-2">âš–ï¸</span>
                    <div>
                        <div class="font-bold text-sm">æç¤ºè©äºŒé¸ä¸€</div>
                        <div class="text-[10px] opacity-70">A/B Testing</div>
                    </div>
                </button>

                <button @click="setMode('tool')" :class="mode === 'tool' ? 'bg-purple-600 text-white shadow-lg shadow-purple-900/50 ring-1 ring-purple-400' : 'bg-slate-700 text-gray-300 hover:bg-slate-600'" class="w-full text-left px-3 py-3 rounded-lg transition flex items-center">
                    <span class="text-xl mr-2">ğŸ§°</span>
                    <div>
                        <div class="font-bold text-sm">AI å·¥å…·ç®±</div>
                        <div class="text-[10px] opacity-70">æƒ…å¢ƒåˆ¤æ–·é¡Œ</div>
                    </div>
                </button>

                <button @click="setMode('lottery')" :class="mode === 'lottery' ? 'bg-yellow-600 text-white shadow-lg shadow-yellow-900/50 ring-1 ring-yellow-400' : 'bg-slate-700 text-gray-300 hover:bg-slate-600'" class="w-full text-left px-3 py-3 rounded-lg transition flex items-center">
                    <span class="text-xl mr-2">ğŸ</span>
                    <div>
                        <div class="font-bold text-sm">å¹¸é‹æŠ½ç</div>
                        <div class="text-[10px] opacity-70">çµæ¥­å¤§ç¦®åŒ…</div>
                    </div>
                </button>
            </div>

            <div class="pt-2 border-t border-slate-700">
                <div class="flex items-center justify-between text-xs bg-black/20 p-2 rounded-lg">
                    <div class="flex items-center">
                        <span class="w-2 h-2 rounded-full mr-2" :class="connectionCount > 0 ? 'bg-green-500 animate-pulse' : 'bg-red-500'"></span>
                        <span class="text-gray-300">å­¸å“¡æ•¸</span>
                    </div>
                    <span class="font-mono text-lg font-bold text-white">{{ connectionCount }}</span>
                </div>
            </div>
        </div>

        <!-- å³å´å¤§è¢å¹•å±•ç¤ºå€ -->
        <div class="flex-1 bg-gradient-to-br from-slate-900 to-black flex flex-col items-center justify-center p-4 relative overflow-hidden">
            
            <!-- ç­‰å¾…é€£ç·š QR Code -->
            <div v-if="connectionCount === 0" class="absolute inset-0 bg-black/90 z-50 flex flex-col items-center justify-center text-white p-6 text-center backdrop-blur-md">
                <h3 class="text-2xl md:text-3xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400">ç­‰å¾…å­¸å“¡é€£ç·š...</h3>
                <div class="bg-white p-3 rounded-xl mb-4 shadow-xl shadow-blue-500/20">
                    <img :src="`https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(shareUrl)}`" alt="QR Code" class="w-40 h-40">
                </div>
                <div class="text-xl">
                    è«‹è¼¸å…¥ ID: <span class="text-yellow-400 font-mono font-bold text-4xl ml-2">{{ displayId }}</span>
                </div>
                <button @click="connectionCount = 1" class="mt-8 text-xs text-gray-500 hover:text-gray-300 transition underline">è·³éç­‰å¾… (åƒ…ä¾›é è¦½æ¸¬è©¦)</button>
            </div>

            <!-- æ¨¡å¼ A: æç¤ºè©äºŒé¸ä¸€ (Quiz) - ç¸®å°ç‰ˆé¢ -->
            <div v-if="mode === 'quiz'" class="text-center w-full max-w-5xl animate__animated animate__fadeIn flex flex-col h-full justify-center">
                <div class="mb-4">
                    <span class="bg-blue-900/50 text-blue-300 px-4 py-1 rounded-full text-xs font-bold border border-blue-500/30 uppercase tracking-widest">Prompt Duel</span>
                </div>
                <h3 class="text-2xl md:text-4xl font-bold mb-8 text-white leading-tight">
                    å“ªä¸€å€‹æç¤ºè© (Prompt) æ•ˆæœæ›´å¥½ï¼Ÿ
                </h3>
                
                <div class="flex flex-col md:flex-row justify-center gap-4 mb-8 w-full px-2 flex-1 max-h-[400px]">
                    <!-- é¸é … A -->
                    <div class="flex-1 bg-gradient-to-br from-blue-600 to-blue-800 p-0.5 rounded-2xl shadow-xl shadow-blue-900/50 transform transition hover:scale-[1.02]">
                        <div class="h-full bg-slate-900 rounded-[14px] p-4 flex flex-col items-center justify-center relative overflow-hidden">
                            <span class="absolute text-[8rem] font-black text-blue-500/10 -top-6 -left-2 select-none">A</span>
                            <div class="relative z-10">
                                <span class="text-5xl font-black text-blue-500 mb-2 block">A</span>
                                <p class="text-lg text-blue-200 font-bold leading-tight">ç²¾ç¢ºã€å…·é«”<br>æœ‰ç¯„ä¾‹</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- VS -->
                    <div class="flex items-center justify-center py-2 md:py-0">
                        <span class="text-3xl font-black text-white italic opacity-30">VS</span>
                    </div>

                    <!-- é¸é … B -->
                    <div class="flex-1 bg-gradient-to-br from-pink-600 to-pink-800 p-0.5 rounded-2xl shadow-xl shadow-pink-900/50 transform transition hover:scale-[1.02]">
                        <div class="h-full bg-slate-900 rounded-[14px] p-4 flex flex-col items-center justify-center relative overflow-hidden">
                            <span class="absolute text-[8rem] font-black text-pink-500/10 -top-6 -right-2 select-none">B</span>
                             <div class="relative z-10">
                                <span class="text-5xl font-black text-pink-500 mb-2 block">B</span>
                                <p class="text-lg text-pink-200 font-bold leading-tight">æ¨¡ç³Šã€ç°¡çŸ­<br>ç„¡ä¸Šä¸‹æ–‡</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- é¡¯ç¤ºå­¸å“¡é¸æ“‡çµæœ -->
                <div v-if="lastAction" class="h-16 flex items-center justify-center animate__animated animate__zoomIn">
                    <div class="bg-slate-800/90 backdrop-blur-md border border-white/20 px-6 py-3 rounded-full flex items-center gap-4 shadow-xl">
                        <span class="text-gray-400 font-bold text-sm">æœ€æ–°å›ç­”ï¼š</span>
                        <span class="text-3xl font-black" :class="lastAction === 'A' ? 'text-blue-400' : 'text-pink-400'">
                            {{ lastAction === 'A' ? 'é¸é … A' : 'é¸é … B' }}
                        </span>
                    </div>
                </div>
                <div v-else class="h-16"></div>
            </div>

            <!-- æ¨¡å¼ B: AI å·¥å…·ç®± - ç¸®å°ç‰ˆé¢ -->
            <div v-if="mode === 'tool'" class="text-center w-full h-full flex flex-col items-center justify-center max-w-3xl animate__animated animate__fadeIn">
                <div class="mb-6">
                    <span class="bg-purple-900/50 text-purple-300 px-4 py-1 rounded-full text-xs font-bold border border-purple-500/30 uppercase tracking-widest">AI Toolkit</span>
                </div>
                
                <div v-if="currentTool" class="glass-panel p-8 rounded-[2rem] shadow-2xl animate__animated animate__backInUp w-full border-t-4" :class="currentTool.color">
                    <div class="text-7xl mb-4 filter drop-shadow-lg">{{ currentTool.emoji }}</div>
                    <div class="text-4xl font-black text-white mb-4">{{ currentTool.name }}</div>
                    <p class="text-lg text-gray-300 leading-relaxed max-w-xl mx-auto bg-black/20 p-3 rounded-xl">{{ currentTool.desc }}</p>
                    <div class="mt-6 py-2 px-6 bg-white/10 rounded-full inline-block text-xs font-mono text-gray-400 tracking-wider">
                        å­¸å“¡é¸æ“‡äº†é€™å€‹åŠŸèƒ½
                    </div>
                </div>
                
                <div v-else class="text-center animate-pulse opacity-50">
                    <div class="text-7xl mb-4">ğŸ¤–</div>
                    <p class="text-2xl text-gray-400 font-light">è«‹è†è½é¡Œç›®ï¼Œé¸æ“‡æ­£ç¢ºçš„ AI åŠŸèƒ½...</p>
                </div>
            </div>

            <!-- æ¨¡å¼ C: å¹¸é‹æŠ½ç - ç¸®å°ç‰ˆé¢ -->
            <div v-if="mode === 'lottery'" class="text-center animate__animated animate__fadeIn flex flex-col justify-center h-full">
                <h3 class="text-3xl md:text-4xl font-black text-yellow-400 mb-8 animate__animated animate__pulse animate__infinite" style="text-shadow: 0 0 20px rgba(250, 204, 21, 0.6);">ğŸ‰ å·¥ä½œåŠå¹¸é‹æ˜Ÿ ğŸ‰</h3>
                
                <div class="bg-slate-800 w-64 h-48 md:w-96 md:h-64 flex items-center justify-center rounded-[2rem] shadow-2xl border-4 border-yellow-500/30 mb-8 relative overflow-hidden group mx-auto">
                    <!-- å…‰æ•ˆ -->
                    <div class="absolute inset-0 bg-yellow-500/5 animate-pulse"></div>
                    <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-30"></div>
                    
                    <div class="text-3xl md:text-5xl font-bold text-white relative z-10 font-mono text-center px-4 leading-tight">
                        {{ lotteryResult }}
                    </div>
                </div>
                
                <div>
                    <button @click="runLottery" :disabled="isRolling" class="bg-gradient-to-r from-yellow-600 to-orange-600 text-white px-10 py-4 rounded-full text-xl md:text-2xl font-bold shadow-lg shadow-yellow-900/50 hover:scale-105 hover:shadow-yellow-600/50 transition-all transform disabled:opacity-50 disabled:scale-100 disabled:cursor-not-allowed">
                        {{ isRolling ? 'æŠ½å‡ºå¹¸é‹å…’...' : 'é–‹å§‹æŠ½ç' }}
                    </button>
                </div>
            </div>

        </div>
    </div>

    <!-- 4. å­¸å“¡ä»‹é¢ (Client - Mobile) -->
    <div v-if="view === 'client'" class="h-full bg-slate-900 p-3 flex flex-col">
        <!-- é ‚éƒ¨ç‹€æ…‹åˆ— -->
        <div class="glass-panel p-3 rounded-xl mb-4 flex justify-between items-center sticky top-0 z-50 bg-slate-900/90 backdrop-blur">
            <div>
                <span class="text-[10px] text-gray-400 block uppercase tracking-wider mb-0.5">Current Task</span>
                <span class="font-bold text-white text-base">
                    {{ modeTitles[mode] }}
                </span>
            </div>
            <div class="flex items-center bg-green-900/30 px-2 py-1 rounded-full border border-green-500/30">
                <span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse mr-1.5"></span>
                <span class="text-[10px] text-green-400 font-mono">ONLINE</span>
            </div>
        </div>

        <!-- Client A: æç¤ºè©äºŒé¸ä¸€ -->
        <div v-if="mode === 'quiz'" class="flex-1 flex flex-col gap-4 justify-center pb-4 max-w-sm mx-auto w-full">
            <button @click="sendAction('A')" class="flex-1 bg-gradient-to-br from-blue-600 to-blue-800 rounded-2xl shadow-lg border-b-4 border-blue-900 active:border-b-0 active:translate-y-1 active:shadow-none transition-all flex flex-col items-center justify-center group relative overflow-hidden min-h-[120px]">
                 <div class="absolute inset-0 bg-blue-400/10 opacity-0 group-hover:opacity-100 transition"></div>
                <span class="text-6xl font-black text-white group-hover:scale-110 transition drop-shadow-lg">A</span>
                <span class="text-blue-200 mt-1 font-bold text-sm">é€™å€‹æ¯”è¼ƒå¥½</span>
            </button>
            <button @click="sendAction('B')" class="flex-1 bg-gradient-to-br from-pink-600 to-pink-800 rounded-2xl shadow-lg border-b-4 border-pink-900 active:border-b-0 active:translate-y-1 active:shadow-none transition-all flex flex-col items-center justify-center group relative overflow-hidden min-h-[120px]">
                <div class="absolute inset-0 bg-pink-400/10 opacity-0 group-hover:opacity-100 transition"></div>
                <span class="text-6xl font-black text-white group-hover:scale-110 transition drop-shadow-lg">B</span>
                <span class="text-pink-200 mt-1 font-bold text-sm">é€™å€‹æ¯”è¼ƒå¥½</span>
            </button>
        </div>

        <!-- Client B: AI å·¥å…·ç®± -->
        <div v-if="mode === 'tool'" class="flex-1 overflow-y-auto pb-2 max-w-sm mx-auto w-full px-1">
            <p class="text-center text-gray-400 mb-4 text-xs">è«‹é‡å°è¬›å¸«çš„æƒ…å¢ƒï¼Œé¸æ“‡å°æ‡‰å·¥å…·ï¼š</p>
            <div class="grid grid-cols-2 gap-3">
                <button v-for="tool in tools" :key="tool.id" @click="sendTool(tool)" class="aspect-square bg-slate-800 rounded-xl shadow border border-slate-700 hover:border-purple-500 active:bg-purple-900/50 active:scale-95 transition flex flex-col items-center justify-center p-2 group">
                    <span class="text-4xl mb-2 group-hover:scale-110 transition">{{ tool.emoji }}</span>
                    <span class="font-bold text-white text-sm">{{ tool.name }}</span>
                </button>
            </div>
        </div>

        <!-- Client C: æŠ½çæ¨¡å¼ -->
        <div v-if="mode === 'lottery'" class="flex-1 flex items-center justify-center flex-col text-center">
            <div class="text-7xl mb-6 animate__animated animate__tada animate__infinite">ğŸ</div>
            <h2 class="text-2xl font-bold text-white mb-2">å¹¸é‹æŠ½çä¸­</h2>
            <p class="text-gray-400 text-sm">è«‹æ³¨è¦–å‰æ–¹å¤§è¢å¹•</p>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed } = Vue;

    createApp({
        setup() {
            const view = ref('home');
            const mode = ref('quiz'); // quiz, tool, lottery
            const myId = ref(''); 
            const displayId = ref(''); // é¡¯ç¤ºç”¨çš„çŸ­ç¢¼
            const targetId = ref(''); 
            const connectionCount = ref(0);
            
            // è³‡æ–™èˆ‡ç‹€æ…‹
            const lastAction = ref(null);
            const currentTool = ref(null);
            
            // å®šç¾© AI å·¥å…·æŒ‰éˆ• (å·²ä¿®æ­£ç‚ºæœ¬åœŸèªæƒ…å¢ƒ)
            const tools = [
                { id: 1, name: 'æ’°å¯«æ•™æ¡ˆ', emoji: 'ğŸ“', desc: 'ChatGPT: ç”¢ç”Ÿ 10 åˆ†é˜å¾®èª²ç¨‹è¨ˆç•«', color: 'border-blue-500' },
                { id: 2, name: 'ç”Ÿæˆæ•™æåœ–', emoji: 'ğŸ¨', desc: 'Midjourney/Bing: ç¹ªè£½åœ¨åœ°å‚³èªªå ´æ™¯', color: 'border-pink-500' },
                { id: 3, name: 'æ¨¡æ“¬å°è©±', emoji: 'ğŸ—£ï¸', desc: 'ChatGPT: æ‰®æ¼”åœ¨åœ°é•·è¼©èˆ‡å­¸ç”Ÿç·´ç¿’', color: 'border-green-500' },
                { id: 4, name: 'è‡ªå‹•å‡ºé¡Œ', emoji: 'âœ…', desc: 'ChatGPT: æ ¹æ“šèª²æ–‡ç”¢ç”Ÿ 5 é¡Œé¸æ“‡é¡Œ', color: 'border-yellow-500' }
            ];
            
            // æŠ½çå…§å®¹ (å·²ä¿®æ­£ç‚ºæœ¬åœŸèªæ•™æ)
            const isRolling = ref(false);
            const lotteryResult = ref('READY');
            const prizes = ['ChatGPT Plus', 'æœ¬åœŸèªæ•™æå¤§ç¦®åŒ…', 'ç²¾ç¾æ–‡å‰µç­†è¨˜æœ¬', 'æ˜Ÿå·´å…‹ç¦®åˆ¸', 'è¬›å¸«ç°½åç…§', 'å†ä¾†ä¸€æ¬¡'];

            let peer = null;
            let conn = null;
            let connections = [];

            const modeTitles = {
                'quiz': 'âš–ï¸ æç¤ºè©äºŒé¸ä¸€',
                'tool': 'ğŸ§° é¸æ“‡åˆé©çš„ AI å·¥å…·',
                'lottery': 'ğŸ å¹¸é‹æŠ½ç'
            };
            
            const shareUrl = computed(() => {
                const url = window.location.href.split('?')[0];
                return `${url}`; 
            });

            // --- Admin: åˆå§‹åŒ– ---
            const initAdmin = () => {
                // ç”¢ç”Ÿ 4 ä½æ•¸éš¨æ©Ÿç¢¼ä½œç‚ºæˆ¿é–“ ID
                const randomId = Math.floor(1000 + Math.random() * 9000);
                displayId.value = randomId.toString();
                // åŠ ä¸Šå‰ç¶´é¿å…è¡çª
                const fullId = 'AI-Teacher-' + randomId;
                
                myId.value = fullId;
                peer = new Peer(fullId);
                
                peer.on('open', (id) => {
                    view.value = 'admin';
                });

                peer.on('connection', (c) => {
                    connections.push(c);
                    connectionCount.value++;
                    
                    // é€£ç·šå¾Œå»£æ’­ç•¶å‰æ¨¡å¼
                    setTimeout(() => {
                        c.send({ type: 'MODE', payload: mode.value });
                    }, 500);

                    c.on('data', (data) => {
                        handleData(data);
                    });
                    
                    c.on('close', () => {
                        connectionCount.value--;
                    });
                });
            };

            // --- Client: é€£ç·š ---
            const connectToAdmin = () => {
                if(!targetId.value) return;
                let inputId = targetId.value.trim();
                // è‡ªå‹•è£œå…¨å‰ç¶´
                let fullId = 'AI-Teacher-' + inputId;

                peer = new Peer(); 
                
                peer.on('open', () => {
                    conn = peer.connect(fullId);
                    
                    conn.on('open', () => {
                        view.value = 'client';
                    });

                    conn.on('data', (data) => {
                        if(data.type === 'MODE') {
                            mode.value = data.payload;
                            currentTool.value = null; // åˆ‡æ›æ¨¡å¼æ™‚æ¸…ç©º
                        }
                    });
                    
                    conn.on('error', (err) => alert('æ‰¾ä¸åˆ°æˆ¿é–“ IDï¼Œè«‹é‡æ–°ç¢ºèª'));
                });
            };

            // --- è³‡æ–™è™•ç† ---
            const handleData = (data) => {
                if(data.type === 'ACTION') {
                    lastAction.value = data.payload;
                    setTimeout(() => { 
                        if(lastAction.value === data.payload) lastAction.value = null; 
                    }, 3000);
                }
                if(data.type === 'TOOL') {
                    currentTool.value = data.payload;
                }
            };

            // --- Admin æ“ä½œ ---
            const setMode = (m) => {
                mode.value = m;
                connections.forEach(c => c.send({ type: 'MODE', payload: m }));
                lastAction.value = null;
                currentTool.value = null;
            };

            const runLottery = () => {
                isRolling.value = true;
                let count = 0;
                const timer = setInterval(() => {
                    lotteryResult.value = prizes[Math.floor(Math.random() * prizes.length)];
                    count++;
                    if(count > 30) {
                        clearInterval(timer);
                        isRolling.value = false;
                        lotteryResult.value = prizes[Math.floor(Math.random() * prizes.length)];
                    }
                }, 80);
            };

            // --- Client æ“ä½œ ---
            const sendAction = (choice) => {
                if(conn) conn.send({ type: 'ACTION', payload: choice });
                // éœ‡å‹•å›é¥‹
                if (navigator.vibrate) navigator.vibrate(50);
            };
            const sendTool = (tool) => {
                if(conn) conn.send({ type: 'TOOL', payload: tool });
                if (navigator.vibrate) navigator.vibrate(50);
            };

            return {
                view, mode, myId, displayId, targetId, connectionCount, shareUrl,
                initAdmin, connectToAdmin,
                modeTitles, lastAction, currentTool, tools,
                setMode, runLottery, isRolling, lotteryResult,
                sendAction, sendTool
            };
        }
    }).mount('#app');
</script>
</body>
</html>
