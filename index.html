<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è€é˜¿å§¨æ±è¥¿æ”¾å“ªè£¡</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¨­å®š Inter å­—é«” -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        /* ç¢ºä¿ä¸‹æ‹‰é¸å–®åœ¨è¡Œå‹•è£ç½®ä¸Šå¯è®€ */
        select:required:invalid {
            color: #6b7280; /* Placeholder text color */
        }
        option[value=""][disabled] {
            display: none;
        }
    </style>
</head>
<body class="min-h-screen">
    <div id="app" class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
        <!-- æ¨™é¡Œå€åŸŸ -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-blue-600 tracking-tight mb-2">
                è€é˜¿å§¨æ±è¥¿æ”¾å“ªè£¡
            </h1>
            <p class="text-gray-500 text-lg">
                æ™ºæ…§è¿½è¹¤ï¼Œå¾æ­¤ä¸å†å¥å¿˜ï¼
            </p>
            <!-- ç”¨æˆ¶IDé¡¯ç¤ºï¼Œæ–¹ä¾¿å”ä½œ/æ¸¬è©¦ -->
            <div id="user-id-display" class="text-xs text-gray-400 mt-2 truncate">
                æ­£åœ¨åˆå§‹åŒ–...
            </div>
        </header>

        <!-- æ–°å¢ç‰©å“å€å¡Š -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">æ–°å¢ç‰©å“èˆ‡ä½ç½®</h2>
            <form id="addItemForm" class="space-y-4">
                <div class="flex flex-col sm:flex-row gap-4">
                    <!-- ç‰©å“åç¨±è¼¸å…¥ (ä¸‹æ‹‰é¸å–®, æ–°å¢) -->
                    <select id="itemName" required
                           class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                        <option value="" disabled selected>â€” è«‹é¸æ“‡ç‰©å“åç¨± (å¿…å¡«) â€”</option>
                    </select>
                    
                    <!-- å®¹å™¨/å„²å­˜ç©ºé–“ (ä¸‹æ‹‰é¸å–®) -->
                    <select id="itemContainer"
                            class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                        <option value="" disabled selected>â€” è«‹é¸æ“‡å®¹å™¨/å„²å­˜ç©ºé–“ (å¯é¸) â€”</option>
                    </select>
                </div>
                
                <!-- ç‰©å“ä½ç½®è¼¸å…¥ (å¤§ä½ç½®) (ä¸‹æ‹‰é¸å–®) -->
                <select id="itemLocation" required
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                    <option value="" disabled selected>â€” è«‹é¸æ“‡å¤§è‡´ä½ç½® (å¿…å¡«) â€”</option>
                </select>

                <!-- åœ–ç‰‡é€£çµè¼¸å…¥ (ä¿æŒå¡«å¯«) -->
                <input type="url" id="itemImageUrl" placeholder="åœ–ç‰‡é€£çµ (å¯é¸ï¼Œe.g., https://.../key.jpg)"
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">

                <!-- æ–°å¢æŒ‰éˆ• -->
                <button type="submit" id="addButton"
                        class="w-full sm:w-auto px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition duration-200 transform hover:scale-[1.01] shadow-md disabled:opacity-50"
                        disabled>
                    + å„²å­˜ç‰©å“
                </button>
            </form>
        </div>

        <!-- ç‰©å“æœå°‹èˆ‡æ¸…å–®å€å¡Š -->
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">æˆ‘çš„ç‰©å“æ¸…å–®</h2>
            
            <!-- æœå°‹è¼¸å…¥æ¡† -->
            <input type="text" id="searchItem" placeholder="ğŸ” æœå°‹ç‰©å“åç¨±ã€å®¹å™¨æˆ–ä½ç½®..."
                   class="w-full p-3 mb-6 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 transition duration-150">

            <!-- ç‰©å“åˆ—è¡¨ -->
            <div id="itemsList" class="space-y-4">
                <p id="loadingMessage" class="text-center text-gray-500">æ­£åœ¨è¼‰å…¥è³‡æ–™...</p>
                <!-- ç‰©å“å¡ç‰‡å°‡æœƒåœ¨é€™è£¡å‹•æ…‹æ’å…¥ -->
            </div>
            
            <p id="noItemsMessage" class="text-center text-gray-500 hidden mt-4">
                æ¸…å–®æ˜¯ç©ºçš„ï¼æ–°å¢ç¬¬ä¸€å€‹ç‰©å“å§ã€‚
            </p>
        </div>
    </div>

    <!-- Firebase è…³æœ¬ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, deleteDoc, collection, query, onSnapshot, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =========================================================================
        // 1. Firebase åˆå§‹åŒ–èˆ‡è¨­å®š
        // =========================================================================
        
        // å…¨åŸŸè®Šæ•¸ (ç”± Canvas ç’°å¢ƒæä¾›)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // åˆå§‹åŒ– Firebase æœå‹™
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        setLogLevel('debug'); // é–‹å•Ÿ Firebase é™¤éŒ¯æ—¥èªŒ

        let userId = null;
        let isAuthReady = false;
        const addButton = document.getElementById('addButton');
        const itemsList = document.getElementById('itemsList');
        const loadingMessage = document.getElementById('loadingMessage');
        const noItemsMessage = document.getElementById('noItemsMessage');
        const searchInput = document.getElementById('searchItem');
        
        // å–å¾— Select å…ƒç´ 
        const itemNameSelect = document.getElementById('itemName'); // ç‰©å“åç¨± Select
        const itemLocationSelect = document.getElementById('itemLocation');
        const itemContainerSelect = document.getElementById('itemContainer');
        
        let currentItemsData = []; // ç”¨æ–¼å„²å­˜æœ€æ–°è³‡æ–™ï¼Œä»¥ä¾¿é€²è¡Œæœå°‹ç¯©é¸

        // é è¨­é¸é …åˆ—è¡¨
        const commonItems = [
            "é‘°åŒ™", "éŒ¢åŒ…", "æ‰‹æ©Ÿå……é›»å™¨", "ç­†è¨˜å‹é›»è…¦", "é™æ§å™¨", "çœ¼é¡", "è­·ç…§", "é‡è¦æ–‡ä»¶", "å‚™ç”¨é›»æ± ", "å¤–æ¥ç¡¬ç¢Ÿ", "å·¥å…·", "è—¥å“"
        ];
        
        const commonLocations = [
            "å®¢å»³", "è‡¥å®¤", "æ›¸æˆ¿", "å»šæˆ¿", "å„²è—å®¤", "è»Šåº«", "é™½å°", "ç„é—œ", "æµ´å®¤", "è¾¦å…¬å®¤"
        ];

        const commonContainers = [
            "æŠ½å±œ", "æ¶å­", "ç´™ç®±", "æ–‡ä»¶å¤¾", "èƒŒåŒ…", "ç¡¬ç¢Ÿç›’", "ä¿éšªç®±", "å·¥å…·ç®±", "è¡£æ«ƒ", "åºŠåº•ä¸‹", "æ¡Œä¸Š"
        ];

        /**
         * å¡«å……ä¸‹æ‹‰é¸å–®é¸é …
         * @param {HTMLElement} selectElement - è¦å¡«å……çš„ <select> å…ƒç´ 
         * @param {Array<string>} optionsArray - é¸é …å­—ä¸²é™£åˆ—
         */
        function populateSelect(selectElement, optionsArray) {
            optionsArray.forEach(optionText => {
                const option = document.createElement('option');
                option.value = optionText;
                option.textContent = optionText;
                selectElement.appendChild(option);
            });
        }
        
        // å¡«å……ä¸‹æ‹‰é¸å–®
        populateSelect(itemNameSelect, commonItems); // å¡«å……ç‰©å“åç¨±
        populateSelect(itemLocationSelect, commonLocations);
        populateSelect(itemContainerSelect, commonContainers);


        // =========================================================================
        // 2. èº«ä»½é©—è­‰é‚è¼¯
        // =========================================================================

        async function authenticate() {
            // ç«‹å³æ›´æ–°ç‹€æ…‹ï¼Œè®“ä½¿ç”¨è€…çŸ¥é“ App æ­£åœ¨å˜—è©¦é€£ç·š
            document.getElementById('user-id-display').textContent = 'æ­£åœ¨å˜—è©¦é€£ç·šåˆ° Firebase...'; 
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase èº«ä»½é©—è­‰å¤±æ•—:", error);
                // å³ä½¿å¤±æ•—ï¼Œä¹Ÿè¦è¨­ç½® isAuthReady ä»¥ä¾¿ç¹¼çºŒåŸ·è¡Œ UI é‚è¼¯
                isAuthReady = true;
                addButton.disabled = false;
                document.getElementById('user-id-display').textContent = 'é€£ç·šå¤±æ•—ï¼ŒåŠŸèƒ½å—é™ (è«‹æª¢æŸ¥ä¸»æ§å°)ã€‚';
            }
        }

        onAuthStateChanged(auth, (user) => {
            isAuthReady = true;
            addButton.disabled = false;

            if (user) {
                userId = user.uid;
                document.getElementById('user-id-display').textContent = `ä½¿ç”¨è€…ID: ${userId}`;
                setupRealtimeListener(userId);
            } else {
                // å¦‚æœæœªç™»å…¥ï¼ˆä¸æ‡‰è©²ç™¼ç”Ÿï¼Œå› ç‚ºæˆ‘å€‘å˜—è©¦äº†åŒ¿åç™»å…¥ï¼‰ï¼Œå‰‡ä½¿ç”¨éš¨æ©Ÿ ID
                userId = crypto.randomUUID(); 
                document.getElementById('user-id-display').textContent = `æœªé©—è­‰ - è‡¨æ™‚ID: ${userId}`;
            }
        });

        // å•Ÿå‹•èº«ä»½é©—è­‰æµç¨‹
        authenticate();

        // =========================================================================
        // 3. Firestore æ“ä½œ
        // =========================================================================

        /**
         * å–å¾—ç‰©å“é›†åˆçš„åƒè€ƒè·¯å¾‘ (ç§æœ‰è·¯å¾‘)
         * @param {string} currentUserId - ç•¶å‰ç”¨æˆ¶ID
         * @returns {import("firebase/firestore").CollectionReference}
         */
        function getItemsCollectionRef(currentUserId) {
            // ç§æœ‰è·¯å¾‘: /artifacts/{appId}/users/{userId}/items
            return collection(db, 'artifacts', appId, 'users', currentUserId, 'items');
        }

        /**
         * æ–°å¢ç‰©å“
         * @param {string} name - ç‰©å“åç¨±
         * @param {string} location - ç‰©å“å¤§è‡´ä½ç½®
         * @param {string} container - ç‰©å“å®¹å™¨/å„²å­˜ç©ºé–“
         * @param {string} [imageUrl] - åœ–ç‰‡é€£çµ (å¯é¸)
         */
        async function addItem(name, location, container, imageUrl) {
            if (!userId) {
                console.error("ç„¡æ³•æ–°å¢ç‰©å“ï¼šç”¨æˆ¶IDå°šæœªè¨­å®šã€‚");
                return;
            }

            try {
                await addDoc(getItemsCollectionRef(userId), {
                    name: name.trim(),
                    location: location.trim(),
                    container: container.trim() || null, // å„²å­˜å®¹å™¨æ¬„ä½
                    imageUrl: imageUrl.trim() || null, 
                    createdAt: serverTimestamp(),
                });
                console.log("ç‰©å“æ–°å¢æˆåŠŸ:", name);
            } catch (e) {
                console.error("æ–°å¢ç‰©å“æ™‚å‡ºéŒ¯:", e);
            }
        }

        /**
         * åˆªé™¤ç‰©å“
         * @param {string} itemId - ç‰©å“çš„ Doc ID
         */
        async function deleteItem(itemId) {
            if (!userId) {
                console.error("ç„¡æ³•åˆªé™¤ç‰©å“ï¼šç”¨æˆ¶IDå°šæœªè¨­å®šã€‚");
                return;
            }
            
            try {
                // å¿…é ˆæä¾›å®Œæ•´çš„è·¯å¾‘
                const itemRef = doc(getItemsCollectionRef(userId), itemId);
                await deleteDoc(itemRef);
                console.log("ç‰©å“åˆªé™¤æˆåŠŸ:", itemId);
            } catch (e) {
                console.error("åˆªé™¤ç‰©å“æ™‚å‡ºéŒ¯:", e);
            }
        }
        
        // =========================================================================
        // 3.5. Gemini TTS èªéŸ³æœ—è®€åŠŸèƒ½ (Text-to-Speech)
        // =========================================================================

        /**
         * å°‡ Base64 å­—ä¸²è½‰æ›ç‚º ArrayBuffer
         * @param {string} base64 - Base64 å­—ä¸²
         * @returns {ArrayBuffer}
         */
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        /**
         * å°‡å­—ä¸²å¯«å…¥ DataView
         * @param {DataView} view - DataView ç‰©ä»¶
         * @param {number} offset - å¯«å…¥èµ·å§‹åç§»é‡
         * @param {string} string - è¦å¯«å…¥çš„å­—ä¸²
         */
        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        /**
         * å°‡ PCM 16-bit éŸ³è¨Šæ•¸æ“šè½‰æ›ç‚º WAV Blob
         * @param {Int16Array} pcm16 - 16ä½å…ƒçš„ PCM éŸ³è¨Šæ•¸æ“š
         * @param {number} sampleRate - å–æ¨£ç‡
         * @returns {Blob} - WAV æ ¼å¼çš„ Blob
         */
        function pcmToWav(pcm16, sampleRate) {
            const numChannels = 1;
            const bytesPerSample = 2; // 16-bit PCM

            const buffer = new ArrayBuffer(44 + pcm16.byteLength);
            const view = new DataView(buffer);

            // RIFF chunk descriptor
            writeString(view, 0, 'RIFF'); // ChunkID
            view.setUint32(4, 36 + pcm16.byteLength, true); // ChunkSize
            writeString(view, 8, 'WAVE'); // Format

            // FMT sub-chunk
            writeString(view, 12, 'fmt '); // Subchunk1ID
            view.setUint32(16, 16, true); // Subchunk1Size (16 for PCM)
            view.setUint16(20, 1, true); // AudioFormat (1 for PCM)
            view.setUint16(22, numChannels, true); // NumChannels
            view.setUint32(24, sampleRate, true); // SampleRate
            view.setUint32(28, sampleRate * numChannels * bytesPerSample, true); // ByteRate
            view.setUint16(32, numChannels * bytesPerSample, true); // BlockAlign
            view.setUint16(34, 16, true); // BitsPerSample

            // Data sub-chunk
            writeString(view, 36, 'data'); // Subchunk2ID
            view.setUint32(40, pcm16.byteLength, true); // Subchunk2Size

            // Write PCM data
            let offset = 44;
            for (let i = 0; i < pcm16.length; i++) {
                view.setInt16(offset, pcm16[i], true);
                offset += 2;
            }

            return new Blob([view], { type: 'audio/wav' });
        }
        
        /**
         * æ’­æ”¾ WAV Blob æ ¼å¼çš„éŸ³è¨Š
         * @param {Blob} wavBlob - WAV æ ¼å¼çš„ Blob
         */
        function playAudioFromWavBlob(wavBlob) {
            const audioUrl = URL.createObjectURL(wavBlob);
            const audio = new Audio(audioUrl);
            audio.play();
            // é‡‹æ”¾ URL ç‰©ä»¶
            audio.onended = () => {
                URL.revokeObjectURL(audioUrl);
            };
        }

        /**
         * å‘¼å« Gemini TTS API ç”¢ç”ŸéŸ³è¨Š
         * @param {string} prompt - è¦è½‰æ›ç‚ºèªéŸ³çš„æ–‡å­—
         * @param {string} voiceName - èªéŸ³åç¨± (e.g., 'Kore')
         * @param {string} itemId - ç‰©å“ ID (ç”¨æ–¼é–å®š/è§£é–æŒ‰éˆ•)
         */
        async function fetchTtsAudio(prompt, voiceName, itemId) {
            const speakButton = document.querySelector(`.speak-btn[data-id="${itemId}"]`);
            if (speakButton) {
                speakButton.disabled = true;
                speakButton.textContent = 'ğŸ”Š è¼‰å…¥ä¸­...';
            }

            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: { prebuiltVoiceConfig: { voiceName: voiceName } }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            let response;
            let retries = 0;
            const maxRetries = 5;
            let delay = 1000;

            while (retries < maxRetries) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        break; // æˆåŠŸï¼Œè·³å‡ºè¿´åœˆ
                    } else if (response.status === 429 || response.status >= 500) {
                        // è™•ç†é™é€Ÿæˆ–ä¼ºæœå™¨éŒ¯èª¤ (é‡è©¦)
                        retries++;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // æŒ‡æ•¸é€€è®“
                        console.warn(`TTS API è«‹æ±‚å¤±æ•—ï¼Œç‹€æ…‹ç¢¼: ${response.status}ã€‚æ­£åœ¨é‡è©¦ ${retries}/${maxRetries}...`);
                    } else {
                        // è™•ç†å…¶ä»–éŒ¯èª¤
                        throw new Error(`TTS API è«‹æ±‚å¤±æ•—ï¼Œç‹€æ…‹ç¢¼: ${response.status}`);
                    }
                } catch (error) {
                    console.error("TTS API å‘¼å«æœŸé–“ç™¼ç”ŸéŒ¯èª¤:", error);
                    break;
                }
            }
            
            if (speakButton) {
                speakButton.disabled = false;
                speakButton.textContent = 'ğŸ”Š å‘Šè¨´æˆ‘ä½ç½®';
            }

            if (!response || !response.ok) {
                console.error("TTS è«‹æ±‚æœ€çµ‚å¤±æ•—æˆ–ç„¡æ³•è§£æå›æ‡‰ã€‚");
                return;
            }

            try {
                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    // MimeType ç¯„ä¾‹: audio/L16; rate=24000
                    const rateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = rateMatch ? parseInt(rateMatch[1], 10) : 24000; // é è¨­ 24000
                    
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    playAudioFromWavBlob(wavBlob);

                } else {
                    console.error("TTS API å›æ‡‰ä¸­ç¼ºå°‘éŸ³è¨Šè³‡æ–™æˆ–æ ¼å¼éŒ¯èª¤ã€‚");
                }
            } catch (error) {
                console.error("è™•ç† TTS å›æ‡‰æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
            }
        }

        /**
         * æº–å‚™æ–‡å­—ä¸¦å‘¼å« TTS æœ—è®€ç‰©å“ä½ç½®
         * @param {Object} item - ç‰©å“ç‰©ä»¶
         */
        function speakItemLocation(item) {
            const containerText = item.container ? `ï¼Œå®¹å™¨ï¼š${item.container}` : '';
            const prompt = `è«‹ç”¨å‹å–„ä¸”æ¸…æ¥šçš„ä¸­æ–‡èªæ°£å”¸å‡ºï¼šç‰©å“ï¼š${item.name} ${containerText}ï¼Œå¤§è‡´ä½ç½®ï¼š${item.location}ã€‚`;
            // ä½¿ç”¨ Kore èªéŸ³ (è²éŸ³è¼ƒç‚ºæ¸…æ™°æ˜ç¢º)
            fetchTtsAudio(prompt, 'Kore', item.id); 
        }

        // =========================================================================
        // 4. å³æ™‚ç›£è½èˆ‡ UI æ›´æ–°
        // =========================================================================

        /**
         * è¨­ç½® Firestore å³æ™‚ç›£è½å™¨
         * @param {string} currentUserId - ç•¶å‰ç”¨æˆ¶ID
         */
        function setupRealtimeListener(currentUserId) {
            if (!currentUserId || !isAuthReady) {
                return; // ç­‰å¾…é©—è­‰å®Œæˆ
            }
            
            const itemsQuery = query(getItemsCollectionRef(currentUserId));
            
            onSnapshot(itemsQuery, (snapshot) => {
                const items = [];
                snapshot.forEach((doc) => {
                    // å°‡ document ID å’Œè³‡æ–™åˆä½µ
                    items.push({ id: doc.id, ...doc.data() });
                });
                
                // ä¾å‰µå»ºæ™‚é–“é™å†ªæ’åºï¼Œæ–°ç‰©å“åœ¨å‰é¢
                items.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));

                currentItemsData = items; // æ›´æ–°å…¨åŸŸè³‡æ–™
                renderItems(currentItemsData); // æ¸²æŸ“æ‰€æœ‰è³‡æ–™
                
                loadingMessage.classList.add('hidden');
                noItemsMessage.classList.toggle('hidden', items.length > 0);

                console.log("è³‡æ–™å·²æ›´æ–°:", items.length, "ç­†è¨˜éŒ„");

            }, (error) => {
                console.error("ç›£è½ Firestore æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
                loadingMessage.textContent = 'è¼‰å…¥è³‡æ–™å¤±æ•—ã€‚';
            });
        }

        /**
         * æ¸²æŸ“ç‰©å“åˆ—è¡¨åˆ° DOM
         * @param {Array<Object>} itemsToRender - è¦æ¸²æŸ“çš„ç‰©å“åˆ—è¡¨
         */
        function renderItems(itemsToRender) {
            itemsList.innerHTML = ''; // æ¸…ç©ºç¾æœ‰åˆ—è¡¨

            if (itemsToRender.length === 0) {
                itemsList.innerHTML = '<p class="text-center text-gray-500 p-4">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„ç‰©å“ã€‚</p>';
                return;
            }

            itemsToRender.forEach(item => {
                // æª¢æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„åœ–ç‰‡é€£çµ
                const imageUrl = item.imageUrl && item.imageUrl.trim() ? item.imageUrl : null;
                const imageHtml = imageUrl ? 
                    // ä½¿ç”¨ onerror è™•ç†åœ–ç‰‡è¼‰å…¥å¤±æ•—ï¼Œé¡¯ç¤ºé ç•™åœ–
                    `<img src="${imageUrl}" alt="${item.name || 'ç‰©å“åœ–ç‰‡'}" 
                          class="w-16 h-16 object-cover rounded-lg mr-4 border border-gray-200 flex-shrink-0 cursor-pointer" 
                          onclick="window.open('${imageUrl}', '_blank')"
                          onerror="this.onerror=null; this.src='https://placehold.co/64x64/E0E7FF/3B82F6?text=No+Img';">` 
                    : '<div class="w-16 h-16 bg-gray-200 rounded-lg mr-4 flex-shrink-0 flex items-center justify-center text-gray-500 text-xs text-center p-1 leading-tight">ç„¡åœ–</div>';
                
                // é¡¯ç¤ºå®¹å™¨/ä½ç½®è³‡è¨Š
                const locationDisplay = item.container && item.container.trim()
                    ? `<span class="font-semibold text-purple-600">${item.container}</span> åœ¨ ${item.location || 'ç„¡å¤§è‡´ä½ç½®'}` 
                    : item.location || 'ç„¡ä½ç½®è³‡è¨Š';

                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex items-start justify-between bg-gray-50 p-4 rounded-xl shadow-sm transition duration-150 hover:shadow-md border border-gray-100';
                itemDiv.innerHTML = `
                    ${imageHtml}
                    <div class="flex-1 min-w-0 pt-1">
                        <p class="text-xl font-bold text-gray-900 truncate">${item.name || 'ç„¡åç¨±'}</p>
                        <p class="text-sm text-gray-600 mt-1 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-purple-500 mr-2 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                            </svg>
                            <span class="truncate">${locationDisplay}</span>
                        </p>
                        <button data-id="${item.id}" class="speak-btn mt-3 px-3 py-1 bg-purple-500 text-white text-xs font-medium rounded-full hover:bg-purple-600 transition duration-150 disabled:opacity-50 flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                            </svg>
                            <span>å‘Šè¨´æˆ‘ä½ç½®</span>
                        </button>
                    </div>
                    <button data-id="${item.id}" class="delete-btn flex-shrink-0 ml-4 p-2 text-red-500 hover:text-white hover:bg-red-600 rounded-full transition duration-150" title="åˆªé™¤">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
                itemsList.appendChild(itemDiv);
            });
            
            // é‡æ–°ç¶å®šäº‹ä»¶
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const itemId = e.currentTarget.getAttribute('data-id');
                    // æ‰¾åˆ°å°æ‡‰çš„ item
                    const itemToDelete = itemsToRender.find(i => i.id === itemId);
                    if (itemToDelete && confirmModal(`ç¢ºå®šè¦åˆªé™¤ "${itemToDelete.name}" å—ï¼Ÿ`)) {
                        deleteItem(itemId);
                    }
                });
            });

            // ç¶å®š TTS æŒ‰éˆ•äº‹ä»¶
            document.querySelectorAll('.speak-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const itemId = e.currentTarget.getAttribute('data-id');
                    const itemToSpeak = currentItemsData.find(i => i.id === itemId);
                    if (itemToSpeak) {
                        speakItemLocation(itemToSpeak);
                    }
                });
            });
        }
        
        /**
         * å³æ™‚æœå°‹/ç¯©é¸åŠŸèƒ½
         */
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase().trim();
            
            if (!searchTerm) {
                renderItems(currentItemsData); // é¡¯ç¤ºæ‰€æœ‰é …ç›®
                noItemsMessage.classList.toggle('hidden', currentItemsData.length > 0);
                return;
            }

            const filteredItems = currentItemsData.filter(item => 
                (item.name && item.name.toLowerCase().includes(searchTerm)) ||
                (item.location && item.location.toLowerCase().includes(searchTerm)) ||
                (item.container && item.container.toLowerCase().includes(searchTerm))
            );
            
            renderItems(filteredItems); // é¡¯ç¤ºç¯©é¸çµæœ
            noItemsMessage.classList.add('hidden'); // ç¯©é¸æ™‚ä¸é¡¯ç¤º "æ¸…å–®æ˜¯ç©ºçš„" è¨Šæ¯
        });


        // =========================================================================
        // 5. äº‹ä»¶ç›£è½å™¨ (è¡¨å–®æäº¤)
        // =========================================================================
        
        document.getElementById('addItemForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            // å¾ Select å…ƒç´ å–å¾—å€¼
            const nameSelect = document.getElementById('itemName');
            const locationSelect = document.getElementById('itemLocation');
            const containerSelect = document.getElementById('itemContainer'); 
            const imageUrlInput = document.getElementById('itemImageUrl');

            const name = nameSelect.value;
            const location = locationSelect.value;
            const container = containerSelect.value; 
            const imageUrl = imageUrlInput.value; 

            // æª¢æŸ¥å¿…å¡«æ¬„ä½ (name å’Œ location)
            if (name && location) {
                addItem(name, location, container, imageUrl);
                
                // æ¸…ç©ºè¡¨å–®
                nameSelect.value = ''; // é‡è¨­ç‚ºé è¨­å€¼
                locationSelect.value = ''; 
                containerSelect.value = ''; 
                imageUrlInput.value = ''; 
                nameSelect.focus();
            } else if (!name) {
                // å¦‚æœ name æ²’é¸
                alert('è«‹é¸æ“‡ç‰©å“åç¨± (å¿…å¡«æ¬„ä½)ã€‚');
                nameSelect.focus();
            } else if (!location) {
                // å¦‚æœ location æ²’é¸
                alert('è«‹é¸æ“‡å¤§è‡´ä½ç½® (å¿…å¡«æ¬„ä½)ã€‚');
                locationSelect.focus();
            }
        });

        // =========================================================================
        // 6. UI è¼”åŠ©åŠŸèƒ½ (è‡ªå®šç¾©æ¨¡æ…‹æ¡†æ›¿ä»£ alert/confirm)
        // =========================================================================

        /**
         * ç°¡æ˜“è‡ªå®šç¾©ç¢ºèªæ¨¡æ…‹æ¡† (æ›¿ä»£ window.confirm)
         * @param {string} message - é¡¯ç¤ºçµ¦ç”¨æˆ¶çš„è¨Šæ¯
         * @returns {boolean} - å¦‚æœç”¨æˆ¶è¼¸å…¥ 'ç¢ºå®š' å‰‡è¿”å› true
         */
        function confirmModal(message) {
            // åœ¨ Canvas ç’°å¢ƒä¸­ï¼Œæˆ‘å€‘ä¸èƒ½ç”¨ alert/confirmï¼Œæ‰€ä»¥ç”¨ prompt æ¨¡æ“¬ã€‚
            const result = prompt(`${message}\n\n (è«‹è¼¸å…¥ 'ç¢ºå®š' ä»¥åˆªé™¤, æˆ–å–æ¶ˆ)`);
            return result === 'ç¢ºå®š';
        }

    </script>
</body>
</html>
